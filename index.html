<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT Buddy - College & Routine Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .tab-active { border-bottom-color: #0d9488; color: #0d9488; }
        .event-item { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .event-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .event-item.dragging { opacity: 0.5; cursor: grabbing; }
        .day-cell { min-height: 200px; }

        /* Event Type Styling */
        .event-type-meal.meal-type-Breakfast { background-color: #E0F2F1; border-left-color: #4DB6AC; }
        .event-type-meal.meal-type-Lunch { background-color: #FFF9C4; border-left-color: #FFD54F; }
        .event-type-meal.meal-type-Dinner { background-color: #F8BBD0; border-left-color: #F06292; }
        .event-type-meal.meal-type-Snack { background-color: #E1F5FE; border-left-color: #4FC3F7; }
        .event-type-routine { background-color: #E0E7FF; border-left-color: #6366F1; } /* Indigo */

        .dot-Breakfast { background-color: #4DB6AC; }
        .dot-Lunch { background-color: #FFD54F; }
        .dot-Dinner { background-color: #F06292; }
        .dot-Snack { background-color: #4FC3F7; }
        .dot-routine { background-color: #6366F1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-6">
            <h1 class="text-4xl lg:text-5xl font-bold text-teal-600"><i class="fas fa-calendar-check mr-2"></i>FIT Buddy</h1>
            <p class="text-gray-500 mt-2">Your fitness and meal planning companion.</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex justify-center space-x-6" aria-label="Tabs">
                <button id="weekly-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg tab-active">Weekly Planner</button>
                <button id="monthly-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Monthly View</button>
                <button id="mealbook-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Meal Book</button>
                <button id="routines-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Routines</button>
            </nav>
        </div>

        <!-- VIEWS -->
        <div id="weekly-view">
            <div id="calendar-container" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4"><button id="prev-week" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-chevron-left"></i></button><h2 id="current-week" class="text-xl lg:text-2xl font-semibold text-gray-700 text-center"></h2><button id="next-week" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-chevron-right"></i></button></div>
                <div class="grid grid-cols-7 text-center font-bold text-gray-500 mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                <div id="calendar-grid" class="calendar-grid gap-2"></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div id="event-details-container" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg hidden"><div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-teal-700">Details</h3><button id="close-details" class="text-gray-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button></div><div id="event-details-content" class="mt-4"></div></div><div id="grocery-list-container" class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-2xl font-bold text-teal-700 mb-4 flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Grocery List</h3><p class="text-sm text-gray-500 mb-4">Auto-generated from meals in the current week.</p><div id="grocery-list" class="space-y-3 h-96 overflow-y-auto pr-2"></div><button id="copy-grocery-list" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg flex items-center justify-center"><i class="fas fa-copy mr-2"></i> Copy List</button></div></div>
        </div>

        <div id="monthly-view" class="hidden"><div class="bg-white p-6 rounded-2xl shadow-lg"><div class="flex justify-between items-center mb-4"><button id="prev-month" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-chevron-left"></i></button><h2 id="current-month" class="text-xl lg:text-2xl font-semibold text-gray-700 text-center"></h2><button id="next-month" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 text-center font-bold text-gray-500 mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div id="monthly-calendar-grid" class="calendar-grid gap-1"></div></div></div>
        
        <div id="mealbook-view" class="hidden"><div class="bg-white p-6 rounded-2xl shadow-lg"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl lg:text-3xl font-bold text-teal-700">My Meal Book</h2><button id="add-new-meal-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Add Meal</button></div><input type="text" id="mealbook-search" placeholder="Search meals..." class="w-full border-gray-300 rounded-lg shadow-sm focus:border-teal-500 focus:ring-teal-500 mb-4"><div id="mealbook-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"></div></div></div>

        <div id="routines-view" class="hidden"><div class="bg-white p-6 rounded-2xl shadow-lg"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl lg:text-3xl font-bold text-indigo-700">My Routines</h2><button id="add-new-routine-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Add Routine</button></div><div id="routine-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"></div></div></div>
    </div>

    <!-- MODALS -->
    <div id="add-event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30"><div class="bg-white rounded-lg p-8 space-y-4"><h3 class="text-xl font-bold text-center mb-4">Add to Your Day</h3><button id="add-meal-from-planner-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Add Meal</button><button id="add-routine-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Add Routine</button><button id="cancel-add-event" class="mt-4 text-sm text-gray-600 hover:text-black">Cancel</button></div></div>
    <div id="add-meal-source-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40"><div class="bg-white rounded-lg p-8 space-y-4"><h3 class="text-xl font-bold text-center mb-4">Add a Meal</h3><button id="choose-from-book-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Choose from Meal Book</button><button id="create-new-meal-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg">Create New Meal</button><button id="cancel-add-meal-source" class="mt-4 text-sm text-gray-600 hover:text-black">Cancel</button></div></div>
    <div id="meal-book-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl"><h2 class="text-2xl font-bold mb-4 text-teal-700">Choose a Meal</h2><input type="text" id="modal-mealbook-search" placeholder="Search meals..." class="w-full border-gray-300 rounded-lg mb-4"><div id="modal-mealbook-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto"></div><button id="cancel-choose-book" class="mt-4 text-gray-600 hover:text-black">Cancel</button></div></div>
    <div id="select-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl"><h2 class="text-2xl font-bold mb-4 text-indigo-700">Select a Routine</h2><div id="modal-routine-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto"></div><button id="cancel-select-routine" class="mt-4 text-gray-600 hover:text-black">Cancel</button></div></div>

    <div id="time-prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-lg p-8 space-y-4"><h3 class="text-xl font-bold text-center mb-4">Schedule Routine</h3><form id="time-form"><div class="flex gap-4"><div class="w-1/2"><label for="start-time" class="block text-sm font-medium text-gray-700">Start Time</label><input type="time" id="start-time" name="start-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required></div><div class="w-1/2"><label for="end-time" class="block text-sm font-medium text-gray-700">End Time</label><input type="time" id="end-time" name="end-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-time-prompt" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></div></form></div></div>

    <div id="meal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-all overflow-y-auto max-h-screen" id="modal-content"><h2 class="text-2xl font-bold mb-6 text-teal-700" id="meal-modal-title">Add Meal</h2><form id="meal-form"><input type="hidden" id="meal-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="meal-title" class="block text-gray-700 font-medium mb-1">Meal Name</label><input type="text" id="meal-title" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-teal-500 focus:ring-teal-500" required></div><div><label for="meal-type" class="block text-gray-700 font-medium mb-1">Meal Type</label><select id="meal-type" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-teal-500 focus:ring-teal-500"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select></div></div><div class="mb-4"><label for="meal-calories" class="block text-gray-700 font-medium mb-1">Calories (kcal)</label><input type="number" id="meal-calories" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-teal-500 focus:ring-teal-500" min="0"></div><div class="mb-4"><label for="meal-url" class="block text-gray-700 font-medium mb-1">Recipe URL</label><input type="url" id="meal-url" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="https://example.com/recipe"></div><div class="mb-4"><label class="block text-gray-700 font-medium mb-1">Ingredients</label><div id="ingredient-inputs" class="space-y-2"></div><button type="button" id="add-ingredient" class="mt-2 text-teal-600 hover:text-teal-800 font-semibold"><i class="fas fa-plus mr-1"></i> Add Ingredient</button></div><div class="mb-4"><label for="meal-instructions" class="block text-gray-700 font-medium mb-1">Instructions</label><textarea id="meal-instructions" rows="4" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-teal-500 focus:ring-teal-500"></textarea></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancel-meal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button><button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg">Save Meal</button></div></form></div></div>
    
    <div id="routine-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md"><h2 class="text-2xl font-bold mb-6 text-indigo-700" id="routine-modal-title">Add Routine</h2><form id="routine-form"><input type="hidden" id="routine-id"><div class="space-y-4"><div><label for="routine-name" class="block text-sm font-medium text-gray-700">Routine Name</label><input type="text" id="routine-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancel-routine" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Save Routine</button></div></form></div></div>

    <div id="message-box" class="fixed top-5 right-5 bg-teal-500 text-white py-2 px-4 rounded-lg shadow-md hidden z-50"><p id="message-text"></p></div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-40"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center"><h3 class="text-lg font-bold text-gray-800 mb-4">Are you sure?</h3><p class="text-gray-600 mb-6">Do you really want to delete this? This cannot be undone.</p><div class="flex justify-center space-x-4"><button id="cancel-delete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button><button id="confirm-delete" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE ---
        const V = 'v12'; 
        const APP_NAME = 'fitBuddy';

        let currentDate = new Date();
        let events = [];
        let mealBook = [];
        let routines = [];
        
        let itemToDelete = null; 
        let currentView = 'weekly';
        let dateForNewEvent = null;
        let pendingEvent = null; 

        // --- DOM ELEMENTS ---
        const weeklyView = document.getElementById('weekly-view');
        const monthlyView = document.getElementById('monthly-view');
        const mealbookView = document.getElementById('mealbook-view');
        const routinesView = document.getElementById('routines-view');
        
        const tabs = {
            weekly: document.getElementById('weekly-tab'),
            monthly: document.getElementById('monthly-tab'),
            mealbook: document.getElementById('mealbook-tab'),
            routines: document.getElementById('routines-tab'),
        };

        const calendarGrid = document.getElementById('calendar-grid'), currentWeekEl = document.getElementById('current-week');
        const monthlyCalendarGrid = document.getElementById('monthly-calendar-grid'), currentMonthEl = document.getElementById('current-month');
        const mealbookList = document.getElementById('mealbook-list'), mealbookSearch = document.getElementById('mealbook-search');
        const routineList = document.getElementById('routine-list');
        
        const eventDetailsContainer = document.getElementById('event-details-container');
        const groceryListEl = document.getElementById('grocery-list');
        const messageBox = document.getElementById('message-box');

        // Modals
        const addEventModal = document.getElementById('add-event-modal');
        const addMealSourceModal = document.getElementById('add-meal-source-modal');
        const mealBookModal = document.getElementById('meal-book-modal');
        const selectRoutineModal = document.getElementById('select-routine-modal');
        const timePromptModal = document.getElementById('time-prompt-modal');
        const mealModal = document.getElementById('meal-modal');
        const routineModal = document.getElementById('routine-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        
        // --- CORE LOGIC ---
        const saveData = () => {
            localStorage.setItem(`${APP_NAME}Events_${V}`, JSON.stringify(events));
            localStorage.setItem(`${APP_NAME}MealBook_${V}`, JSON.stringify(mealBook));
            localStorage.setItem(`${APP_NAME}Routines_${V}`, JSON.stringify(routines));
        };

        const loadData = () => {
            events = JSON.parse(localStorage.getItem(`${APP_NAME}Events_${V}`)) || [];
            mealBook = JSON.parse(localStorage.getItem(`${APP_NAME}MealBook_${V}`)) || [];
            routines = JSON.parse(localStorage.getItem(`${APP_NAME}Routines_${V}`)) || [];
        }

        const switchView = (view) => {
            currentView = view;
            [weeklyView, monthlyView, mealbookView, routinesView].forEach(v => v.classList.add('hidden'));
            Object.values(tabs).forEach(t => t.classList.remove('tab-active'));
            
            tabs[view].classList.add('tab-active');
            document.getElementById(`${view}-view`).classList.remove('hidden');

            if (view === 'weekly') renderWeeklyCalendar();
            if (view === 'monthly') renderMonthlyCalendar();
            if (view === 'mealbook') renderMealBook();
            if (view === 'routines') renderRoutines();
        };

        const showMessage = (message, duration = 3000) => {
            document.getElementById('message-text').textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), duration);
        };

        const getWeek = (date) => [0,1,2,3,4,5,6].map(i => { const d = new Date(date); d.setDate(d.getDate() - d.getDay() + i); return d; });
        const isToday = (date) => new Date().toDateString() === date.toDateString();

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':');
            const hours = parseInt(h, 10);
            const suffix = hours >= 12 ? 'PM' : 'AM';
            const civilianHours = ((hours + 11) % 12 + 1);
            return `${civilianHours}:${m} ${suffix}`;
        };
        
        function parseFraction(fraction) {
            if (typeof fraction === 'number') return fraction;
            if (typeof fraction !== 'string') return 0;
            fraction = fraction.trim();
            if (fraction.includes('/')) {
                const parts = fraction.split('/');
                if (parts.length === 2) {
                    const num = parseFloat(parts[0]);
                    const den = parseFloat(parts[1]);
                    if (!isNaN(num) && !isNaN(den) && den !== 0) {
                        return num / den;
                    }
                }
            }
            return parseFloat(fraction) || 0;
        }

        const upsertMealInBook = (mealData) => {
            const mealId = document.getElementById('meal-id').value;
            let existingIndex = -1;

            if (mealId) {
                existingIndex = mealBook.findIndex(m => m.id === mealId);
            }

            const bookEntry = {
                title: mealData.title,
                mealType: mealData.mealType,
                calories: mealData.calories,
                url: mealData.url,
                ingredients: mealData.ingredients,
                instructions: mealData.instructions,
            };

            if (existingIndex !== -1) {
                mealBook[existingIndex] = { ...mealBook[existingIndex], ...bookEntry };
                return mealBook[existingIndex].id;
            } else {
                const newId = 'book-' + Date.now();
                mealBook.push({ id: newId, ...bookEntry });
                return newId;
            }
        };
        
        // --- RENDER FUNCTIONS ---
        const renderWeeklyCalendar = () => {
            calendarGrid.innerHTML = '';
            const week = getWeek(currentDate);
            currentWeekEl.textContent = `${week[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${week[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            week.forEach(day => {
                const dayStr = day.toDateString();
                const dayEl = document.createElement('div');
                dayEl.className = 'day-cell border border-gray-200 rounded-lg p-2 bg-gray-50 flex flex-col';
                dayEl.dataset.date = day.toISOString();
                
                const dayHeader = document.createElement('div');
                dayHeader.className = `text-center font-medium mb-2 flex items-center justify-center mx-auto w-8 h-8 rounded-full ${isToday(day) ? 'bg-teal-500 text-white' : ''}`;
                dayHeader.textContent = day.getDate();
                
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'events-container space-y-1.5 overflow-y-auto flex-grow';
                const dayEvents = events.filter(e => new Date(e.date).toDateString() === dayStr)
                
                const dayMeals = dayEvents.filter(e => e.type === 'meal');
                const dayRoutines = dayEvents.filter(e => e.type === 'routine').sort((a,b) => (a.startTime || '23:59').localeCompare(b.startTime || '23:59'));

                dayMeals.forEach(event => eventsContainer.appendChild(createEventElement(event)));
                if(dayMeals.length > 0 && dayRoutines.length > 0) {
                    const separator = document.createElement('hr');
                    separator.className = 'my-2';
                    eventsContainer.appendChild(separator);
                }
                dayRoutines.forEach(event => eventsContainer.appendChild(createEventElement(event)));
                
                const dayFooter = document.createElement('div');
                dayFooter.className = 'mt-auto pt-2 border-t border-gray-200 flex justify-between items-center';
                const totalCalories = dayEvents.filter(e => e.type === 'meal').reduce((sum, meal) => sum + (meal.calories || 0), 0);
                dayFooter.innerHTML = `<div class="text-xs text-gray-600 font-semibold"><i class="fas fa-fire-alt text-orange-400"></i> ${totalCalories} kcal</div>`;
                const addEventBtn = document.createElement('button');
                addEventBtn.className = 'text-teal-500 hover:text-teal-700 p-1 rounded-full hover:bg-gray-200 w-7 h-7 flex items-center justify-center';
                addEventBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addEventBtn.onclick = () => openAddEventOptions(day);
                dayFooter.appendChild(addEventBtn);

                dayEl.appendChild(dayHeader);
                dayEl.appendChild(eventsContainer);
                dayEl.appendChild(dayFooter);
                dayEl.addEventListener('dragover', handleDragOver);
                dayEl.addEventListener('drop', handleDrop);
                calendarGrid.appendChild(dayEl);
            });
            renderGroceryList();
        };

        const createEventElement = (event) => {
             const eventEl = document.createElement('div');
            eventEl.className = `event-item p-1.5 rounded-md border-l-4 text-sm event-type-${event.type}`;
            if (event.type === 'meal') {
               eventEl.classList.add(`meal-type-${event.mealType}`);
            }
            eventEl.draggable = true;
            eventEl.dataset.eventId = event.id;
            
            const timeText = event.startTime ? `<div class="text-xs font-semibold text-gray-600">${formatTime(event.startTime)}</div>` : '';
            const titleText = `<div class="font-bold">${event.title}</div>`;

            eventEl.innerHTML = `${titleText}${timeText}`;
            eventEl.onclick = () => showEventDetails(event);
            eventEl.addEventListener('dragstart', handleDragStart);
            return eventEl;
        }

        const renderMonthlyCalendar = () => {
             monthlyCalendarGrid.innerHTML = '';
            currentMonthEl.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const month = currentDate.getMonth(), year = currentDate.getFullYear();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                monthlyCalendarGrid.appendChild(document.createElement('div'));
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const day = new Date(year, month, i);
                const dayStr = day.toDateString();
                const dayEl = document.createElement('div');
                dayEl.className = 'border border-gray-100 p-1 min-h-[120px] flex flex-col hover:bg-gray-200 transition cursor-pointer';
                dayEl.onclick = () => { currentDate = day; switchView('weekly'); };
                
                const dayEvents = events.filter(e => new Date(e.date).toDateString() === dayStr);
                const dayMeals = dayEvents.filter(e => e.type === 'meal');
                const totalCalories = dayMeals.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                
                let caloriesHtml = '';
                if (totalCalories > 0) {
                    caloriesHtml = `<div class="text-xs text-gray-500 font-semibold mt-1"><i class="fas fa-fire-alt text-orange-400"></i> ${totalCalories}</div>`;
                }

                dayEl.innerHTML = `
                    <div class="text-sm font-medium h-6 w-6 flex items-center justify-center rounded-full ${isToday(day) ? 'bg-teal-500 text-white' : 'text-gray-600'}">${i}</div>
                    ${caloriesHtml}
                    <div class="dots-container flex-grow flex flex-wrap gap-1 mt-2"></div>
                `;

                const dotsContainer = dayEl.querySelector('.dots-container');
                const mealTypesPresent = [...new Set(dayMeals.map(m => m.mealType))];
                mealTypesPresent.forEach(type => {
                    dotsContainer.innerHTML += `<div class="w-2 h-2 rounded-full dot-${type}" title="${type}"></div>`;
                });
                if (dayEvents.some(e => e.type === 'routine')) {
                    dotsContainer.innerHTML += `<div class="w-2 h-2 rounded-full dot-routine" title="Routine"></div>`;
                }

                monthlyCalendarGrid.appendChild(dayEl);
            }
        };

        const renderMealBook = (searchTerm = '') => {
            mealbookList.innerHTML = '';
            const filteredBook = mealBook.filter(m => m.title.toLowerCase().includes(searchTerm.toLowerCase()));
             if(filteredBook.length === 0 && searchTerm === '') {
                 mealbookList.innerHTML = `<p class="text-gray-500 italic col-span-full text-center mt-4">Your meal book is empty. Click "Add Meal" to start!</p>`;
             }
            filteredBook.forEach(meal => {
                const card = document.createElement('div');
                card.className = 'border rounded-lg p-4 bg-white shadow-sm flex flex-col justify-between';
                card.innerHTML = `<div><h4 class="font-bold text-lg text-teal-700">${meal.title}</h4><p class="text-sm text-gray-500 mt-1"><i class="fas fa-fire-alt text-orange-400 mr-1"></i>${meal.calories || 0} kcal</p><p class="text-sm text-gray-600 mt-2 truncate">${meal.instructions || 'No instructions.'}</p></div><div class="mt-4 flex justify-end space-x-2"><button class="edit-meal-btn text-gray-500 hover:text-blue-500" data-meal-id="${meal.id}"><i class="fas fa-edit"></i></button><button class="delete-meal-btn text-gray-500 hover:text-red-500" data-meal-id="${meal.id}"><i class="fas fa-trash"></i></button></div>`;
                mealbookList.appendChild(card);
            });
            mealbookList.querySelectorAll('.edit-meal-btn').forEach(btn => btn.onclick = () => openMealModal(mealBook.find(m => m.id === btn.dataset.mealId)));
            mealbookList.querySelectorAll('.delete-meal-btn').forEach(btn => btn.onclick = () => confirmDelete({type: 'mealbook', id: btn.dataset.mealId}));
        };

        const renderRoutines = () => {
            routineList.innerHTML = '';
            if (routines.length === 0) {
                routineList.innerHTML = `<p class="text-gray-500 italic col-span-full text-center mt-4">No routines created yet. Click "Add Routine" to start!</p>`;
            }
            routines.forEach(routine => {
                const card = document.createElement('div');
                card.className = 'border rounded-lg p-4 bg-white shadow-sm flex justify-between items-center';
                card.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg text-gray-800">${routine.name}</h4>
                    </div>
                    <div class="space-x-2">
                        <button class="edit-routine-btn text-gray-500 hover:text-blue-500" data-routine-id="${routine.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-routine-btn text-gray-500 hover:text-red-500" data-routine-id="${routine.id}"><i class="fas fa-trash"></i></button>
                    </div>`;
                routineList.appendChild(card);
            });
            routineList.querySelectorAll('.edit-routine-btn').forEach(btn => btn.onclick = () => openRoutineModal(routines.find(r => r.id === btn.dataset.routineId)));
            routineList.querySelectorAll('.delete-routine-btn').forEach(btn => btn.onclick = () => confirmDelete({type: 'routine', id: btn.dataset.routineId}));
        };

        const renderGroceryList = () => {
            const week = getWeek(currentDate);
            const startOfWeek = new Date(week[0]); startOfWeek.setHours(0,0,0,0);
            const endOfWeek = new Date(week[6]); endOfWeek.setHours(23,59,59,999);
            const weekMeals = events.filter(e => {
                if (e.type !== 'meal') return false;
                const d = new Date(e.date);
                return d >= startOfWeek && d <= endOfWeek;
            });
            const aggregated = {};
            weekMeals.flatMap(m => m.ingredients || []).forEach(ing => {
                if (!ing.name || !ing.quantity) return;
                const quantity = parseFraction(ing.quantity);
                const key = `${ing.name.toLowerCase().trim()}|${(ing.unit || '').toLowerCase().trim()}`;
                if (aggregated[key]) { aggregated[key].quantity += quantity; }
                else { aggregated[key] = { name: ing.name.trim(), quantity: quantity, unit: (ing.unit || '').trim() }; }
            });
            groceryListEl.innerHTML = '';
            const sorted = Object.values(aggregated).sort((a,b) => a.name.localeCompare(b.name));
            if (sorted.length > 0) {
                sorted.forEach(ing => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center bg-gray-100 p-2 rounded-lg';
                    li.innerHTML = `<input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500 mr-3 flex-shrink-0"><span class="flex-grow">${ing.name}</span><span class="font-semibold text-gray-600 ml-2">${ing.quantity} ${ing.unit}</span>`;
                    groceryListEl.appendChild(li);
                });
            } else { groceryListEl.innerHTML = '<p class="text-gray-500 italic">No meals planned for this week.</p>'; }
        };

        // --- EVENT HANDLERS & MODAL LOGIC ---
        let draggedEventId = null;
        const handleDragStart = (e) => {
             draggedEventId = e.target.dataset.eventId;
            e.dataTransfer.setData('text/plain', draggedEventId);
            setTimeout(() => e.target.classList.add('dragging'), 0);
        };
        const handleDragOver = (e) => e.preventDefault();
        const handleDrop = (e) => {
             e.preventDefault();
            const targetCell = e.target.closest('.day-cell');
            document.querySelector('.dragging')?.classList.remove('dragging');
            if (!draggedEventId || !targetCell) return;
            const event = events.find(ev => ev.id === draggedEventId);
            if (event) {
                event.date = targetCell.dataset.date;
                saveData();
                renderWeeklyCalendar();
            }
            draggedEventId = null;
        };
        
        const closeAllModals = () => {
            document.querySelectorAll('.fixed.inset-0').forEach(m => m.classList.add('hidden'));
        };

        const openAddEventOptions = (date) => {
            dateForNewEvent = date;
            addEventModal.classList.remove('hidden');
        };

        const addIngredientInput = (ing = { name: '', quantity: '1', unit: '' }) => {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 gap-2 items-center';
            div.innerHTML = `<input type="text" placeholder="Ingredient" value="${ing.name}" class="col-span-6 p-2 text-sm border-gray-300 rounded-md ingredient-name"><input type="text" placeholder="Qty (e.g., 1/2)" value="${ing.quantity}" class="col-span-2 p-2 text-sm border-gray-300 rounded-md ingredient-qty"><input type="text" placeholder="Unit" value="${ing.unit}" class="col-span-3 p-2 text-sm border-gray-300 rounded-md ingredient-unit"><button type="button" class="col-span-1 text-red-500 hover:text-red-700 remove-btn"><i class="fas fa-trash-alt"></i></button>`;
            div.querySelector('.remove-btn').onclick = () => div.remove();
            document.getElementById('ingredient-inputs').appendChild(div);
        };

        const openMealModal = (mealToEdit = null) => {
            const form = document.getElementById('meal-form');
            form.reset();
            document.getElementById('ingredient-inputs').innerHTML = '';
            if (mealToEdit) {
                document.getElementById('meal-modal-title').textContent = 'Edit Meal';
                document.getElementById('meal-id').value = mealToEdit.id;
                document.getElementById('meal-title').value = mealToEdit.title || '';
                document.getElementById('meal-type').value = mealToEdit.mealType || 'Breakfast';
                document.getElementById('meal-calories').value = mealToEdit.calories || '';
                document.getElementById('meal-url').value = mealToEdit.url || '';
                document.getElementById('meal-instructions').value = mealToEdit.instructions || '';
                (mealToEdit.ingredients || []).forEach(ing => addIngredientInput(ing));
            } else {
                document.getElementById('meal-modal-title').textContent = 'Create New Meal';
                document.getElementById('meal-id').value = '';
                addIngredientInput();
            }
            mealModal.classList.remove('hidden');
        };
        
        const openMealBookModal = () => {
            const listEl = document.getElementById('modal-mealbook-list');
            const searchEl = document.getElementById('modal-mealbook-search');
            const renderList = (term = '') => {
                listEl.innerHTML = '';
                const filteredBook = mealBook.filter(m => m.title.toLowerCase().includes(term.toLowerCase()));
                if(filteredBook.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 italic col-span-full">No meals found in your book.</p>`;
                }
                filteredBook.forEach(meal => {
                    const card = document.createElement('div');
                    card.className = 'border rounded p-3 cursor-pointer hover:bg-gray-100';
                    card.innerHTML = `<h5 class="font-semibold">${meal.title}</h5><p class="text-sm text-gray-500"><i class="fas fa-fire-alt text-orange-400 mr-1"></i>${meal.calories || 0} kcal</p>`;
                    card.onclick = () => { 
                        const newMealEvent = {
                            ...meal,
                            id: 'event-' + Date.now(),
                            mealBookId: meal.id,
                            type: 'meal',
                            date: dateForNewEvent.toISOString(),
                        };
                        events.push(newMealEvent);
                        saveData();
                        closeAllModals();
                        renderWeeklyCalendar();
                    };
                    listEl.appendChild(card);
                });
            };
            searchEl.oninput = () => renderList(searchEl.value);
            renderList();
            mealBookModal.classList.remove('hidden');
        };

        const openSelectRoutineModal = () => {
             const listEl = document.getElementById('modal-routine-list');
            listEl.innerHTML = '';
            if(routines.length === 0) {
                 listEl.innerHTML = `<p class="text-gray-500 italic col-span-full">No routines found. Go to the "Routines" tab to create one.</p>`;
            }
            routines.forEach(routine => {
                const card = document.createElement('div');
                card.className = 'border rounded p-3 cursor-pointer hover:bg-gray-100 flex items-center gap-3';
                card.innerHTML = `<h5 class="font-semibold">${routine.name}</h5>`;
                card.onclick = () => {
                    pendingEvent = {
                        type: 'routine',
                        title: routine.name
                    };
                    selectRoutineModal.classList.add('hidden');
                    timePromptModal.classList.remove('hidden');
                };
                listEl.appendChild(card);
            });
            selectRoutineModal.classList.remove('hidden');
        };
        const openRoutineModal = (routine = null) => {
            const form = document.getElementById('routine-form');
            form.reset();
            if (routine) {
                document.getElementById('routine-modal-title').textContent = 'Edit Routine';
                document.getElementById('routine-id').value = routine.id;
                document.getElementById('routine-name').value = routine.name;
            } else {
                document.getElementById('routine-modal-title').textContent = 'Add New Routine';
                document.getElementById('routine-id').value = '';
            }
            routineModal.classList.remove('hidden');
        };

        document.getElementById('meal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const mealData = {
                title: document.getElementById('meal-title').value.trim(),
                mealType: document.getElementById('meal-type').value,
                calories: parseInt(document.getElementById('meal-calories').value) || 0,
                url: document.getElementById('meal-url').value.trim(),
                ingredients: Array.from(document.querySelectorAll('#ingredient-inputs > div')).map(row => ({ 
                    name: row.querySelector('.ingredient-name').value.trim(),
                    quantity: row.querySelector('.ingredient-qty').value || '0',
                    unit: row.querySelector('.ingredient-unit').value.trim()
                })).filter(i => i.name),
                instructions: document.getElementById('meal-instructions').value.trim()
            };
            if (!mealData.title) return showMessage('Meal name is required.');

            const mealBookId = upsertMealInBook(mealData);

            if (dateForNewEvent) {
                 const newMealEvent = {
                    ...mealData,
                    id: 'event-' + Date.now(),
                    mealBookId: mealBookId,
                    type: 'meal',
                    date: dateForNewEvent.toISOString(),
                };
                events.push(newMealEvent);
                renderWeeklyCalendar();
            }
            
            saveData();
            closeAllModals();
            showMessage('Meal saved!');
            if (currentView === 'mealbook') {
                renderMealBook();
            }
            dateForNewEvent = null; 
        });

        document.getElementById('routine-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('routine-id').value;
            const name = document.getElementById('routine-name').value.trim();
            if (!name) return showMessage('Routine name is required.');

            if (id) {
                const index = routines.findIndex(r => r.id === id);
                routines[index] = { ...routines[index], name };
            } else {
                routines.push({ id: 'routine-' + Date.now(), name });
            }
            saveData();
            renderRoutines();
            routineModal.classList.add('hidden');
        });
        
        document.getElementById('time-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!pendingEvent) return;
            
            const newEvent = {
                ...pendingEvent,
                id: 'event-' + Date.now(),
                date: dateForNewEvent.toISOString(),
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
            };

            events.push(newEvent);
            saveData();
            closeAllModals();
            renderWeeklyCalendar();
            pendingEvent = null;
        });

        const showEventDetails = (event) => {
            const contentEl = document.getElementById('event-details-content');
            let html = '';
            if (event.type === 'meal') {
                const ingredientsHtml = (event.ingredients || []).map(i => `<tr class="border-b"><td class="py-2 pr-4">${i.name}</td><td class="py-2 text-right">${i.quantity} ${i.unit}</td></tr>`).join('') || '<tr><td class="py-2" colspan="2">No ingredients listed.</td></tr>';
                const urlHtml = event.url ? `<div class="mt-4"><a href="${event.url}" target="_blank" class="text-teal-600 hover:text-teal-800 font-semibold">View Recipe <i class="fas fa-external-link-alt fa-xs"></i></a></div>` : '';
                html = `<h4 class="text-xl font-semibold mb-2">${event.title} <span class="text-base font-normal text-gray-500">- ${event.mealType}</span></h4><p class="text-sm text-gray-500"><i class="fas fa-fire-alt text-orange-400 mr-1"></i>${event.calories || 0} kcal</p><p class="text-gray-500 mb-4">${new Date(event.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p><div class="mt-4"><h5 class="font-bold mb-2 text-teal-600">Ingredients:</h5><table class="w-full text-left">${ingredientsHtml}</table></div><div class="mt-4"><h5 class="font-bold mb-2 text-teal-600">Instructions:</h5><p class="whitespace-pre-wrap">${event.instructions || 'No instructions provided.'}</p></div>${urlHtml}`;
            } else { // Routine
                html = `<h4 class="text-xl font-semibold mb-2">${event.title}</h4><p class="text-gray-500 mb-4">${new Date(event.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>`;
            }
             html += `<div class="mt-6 flex space-x-3"><button id="delete-event-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-trash mr-2"></i>Delete</button></div>`;
            
            contentEl.innerHTML = html;
            eventDetailsContainer.classList.remove('hidden');
            eventDetailsContainer.scrollIntoView({ behavior: 'smooth' });

            document.getElementById('delete-event-btn').onclick = () => confirmDelete({type: 'event', id: event.id});
        };

        const confirmDelete = (item) => {
            itemToDelete = item;
            deleteConfirmModal.classList.remove('hidden');
        };

        const handleDelete = () => {
            if (!itemToDelete) return;

            if (itemToDelete.type === 'event') {
                events = events.filter(e => e.id !== itemToDelete.id);
                showMessage('Event deleted.');
            } else if (itemToDelete.type === 'mealbook') {
                mealBook = mealBook.filter(m => m.id !== itemToDelete.id);
                events = events.filter(e => e.type !== 'meal' || e.mealBookId !== itemToDelete.id);
                showMessage('Meal deleted from book and calendar.');
            } else if (itemToDelete.type === 'routine') {
                const routineToDelete = routines.find(r => r.id === itemToDelete.id);
                if (routineToDelete) {
                    routines = routines.filter(r => r.id !== itemToDelete.id);
                    events = events.filter(e => e.type !== 'routine' || e.title !== routineToDelete.name);
                    showMessage('Routine and all its scheduled events deleted.');
                }
            }
            saveData();
            closeAllModals();
            eventDetailsContainer.classList.add('hidden');
            switchView(currentView);
            itemToDelete = null;
        };

        // --- EVENT LISTENERS ---
        Object.keys(tabs).forEach(key => tabs[key].addEventListener('click', () => switchView(key)));
        ['prev-week', 'next-week', 'prev-month', 'next-month'].forEach(id => document.getElementById(id).addEventListener('click', (e) => {
            const action = e.currentTarget.id;
            if (action.includes('week')) currentDate.setDate(currentDate.getDate() + (action.startsWith('prev') ? -7 : 7));
            if (action.includes('month')) currentDate.setMonth(currentDate.getMonth() + (action.startsWith('prev') ? -1 : 1));
            if (currentView === 'weekly') renderWeeklyCalendar(); else renderMonthlyCalendar();
        }));
        
        document.getElementById('add-ingredient').addEventListener('click', () => addIngredientInput());
        document.getElementById('cancel-add-event').addEventListener('click', closeAllModals);
        document.getElementById('cancel-add-meal-source').addEventListener('click', closeAllModals);
        document.getElementById('cancel-choose-book').addEventListener('click', closeAllModals);
        document.getElementById('cancel-select-routine').addEventListener('click', closeAllModals);
        document.getElementById('cancel-time-prompt').addEventListener('click', closeAllModals);
        document.getElementById('cancel-meal').addEventListener('click', closeAllModals);
        document.getElementById('cancel-routine').addEventListener('click', closeAllModals);
        document.getElementById('cancel-delete').addEventListener('click', closeAllModals);
        
        document.getElementById('add-new-routine-btn').addEventListener('click', () => openRoutineModal());
        document.getElementById('add-new-meal-btn').addEventListener('click', () => {
             dateForNewEvent = null; 
             openMealModal();
        });

        document.getElementById('add-meal-from-planner-btn').addEventListener('click', () => { 
            addEventModal.classList.add('hidden'); 
            addMealSourceModal.classList.remove('hidden');
        });
        document.getElementById('create-new-meal-btn').addEventListener('click', () => { addMealSourceModal.classList.add('hidden'); openMealModal(); });
        document.getElementById('choose-from-book-btn').addEventListener('click', () => { addMealSourceModal.classList.add('hidden'); openMealBookModal(); });

        document.getElementById('add-routine-btn').addEventListener('click', () => { addEventModal.classList.add('hidden'); openSelectRoutineModal(); });
        
        document.getElementById('confirm-delete').addEventListener('click', handleDelete);
        document.getElementById('close-details').addEventListener('click', () => eventDetailsContainer.classList.add('hidden'));
        document.getElementById('copy-grocery-list').addEventListener('click', () => { /* existing logic */ });

        // --- INITIALIZATION ---
        loadData();
        switchView('weekly');
    });
    </script>
</body>
</html>
